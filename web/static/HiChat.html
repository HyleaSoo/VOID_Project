<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>chat2222</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" href="./css/json.css">
    <link rel="stylesheet" href="./css/main.css">
    <script src="./js/rium.js"></script>
    <script src="./js/main.js"></script>
    <script>
        const host = 'http://127.0.0.1:5555/api/v1/';

        const login = (account, password) => {
            request(`${host}user/login`, 'POST', {account: account, password: password}).then(r => {
                (r.data && r.data.userId && r.data.token && r.data.expireTime && (
                    localStorage.setItem('userId', r.data.userId),
                    localStorage.setItem('token', r.data.token),
                    localStorage.setItem('expireTime', r.data.expireTime)
                ), true) || (r.message && alert(r.message), true) || alert('登录失败');
            });
        }
        // localStorage.getItem('token') && Date.now() < localStorage.getItem('expireTime') || login(...prompt().split(','));
    </script>
    <script>
        // request(`${host}astro/milky way`).then(r => document.body.append(renderJson(r)));
    </script>
</head>

<body class="body">
    <input type="button" id="loginBtn" value="login">
    <script>
        loginBtn.onclick = _ => login(...prompt().split(','));
    </script>

    <div>
        <input type="text" id="message">
        <button onclick="sendmsg()">发送</button>
        <button onclick="closeMessage()">停止</button>
    </div>
    <div id="messages"></div>
    <script>
        let conn = new WebSocket('ws://127.0.0.1:5555/api/v1/message/send?userId=2&token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjIsImlzcyI6IjIiLCJzdWIiOiJjaGF0IiwiZXhwIjoxNjg2MzEwNDMwLCJuYmYiOjE2ODYzMDMyMzAsImlhdCI6MTY4NjMwMzIzMH0.II5rNAVo93cJJzIjBydAWbQN_WrjUTkjeri7_Qnew38');
        conn.onopen = e => {
            console.log('[open] Connection established');
            // conn.send("ping");
        };
        conn.onclose = e => {
            if (e.wasClean) {
                console.log(`[close] Connection closed cleanly, :${e}`);
            } else {
                console.log('[close] Connection died');
            }
        };
        conn.onerror = e => {
            console.log(`[error] ${e.message}`);
        };

        function sendmsg() {
            conn.send(JSON.stringify({target_id:1, content:document.getElementById("message").value}),);
            let messageElem = document.createElement('div');
            messageElem.textContent = document.getElementById("message").value;
            document.getElementById('messages').prepend(messageElem);
            return false;
        }
        conn.onmessage = e => {
            let messageElem = document.createElement('div');
            messageElem.textContent = e.content;
            document.getElementById('messages').prepend(messageElem);
        }
        function closeMessage(){
            conn.close(1000, "关闭");
        }
    </script>
</body>

</html>